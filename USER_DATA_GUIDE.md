# 用户数据保存指南

## 功能概述

本系统已完全配置好用户数据、对话历史等内容的保存功能。以下是详细说明：

## ✅ 已实现的功能

### 1. 用户认证系统
- **用户注册**：支持邮箱、密码、昵称注册
- **用户登录**：基于 NextAuth.js 的会话管理
- **密码加密**：使用 bcrypt 进行密码哈希
- **会话持久化**：支持跨页面会话保持

### 2. 对话数据保存
- **自动会话创建**：用户发送第一条消息时自动创建会话
- **消息保存**：用户和AI的每条消息都会保存到数据库
- **会话关联**：所有消息都正确关联到对应用户
- **Token统计**：记录API调用的token使用情况

### 3. 数据关系
```
用户 (User)
├── 会话 (Conversation) - 一对多
    └── 消息 (Message) - 一对多
```

### 4. 数据库表结构
- **User表**：存储用户基本信息
- **Conversation表**：存储对话会话
- **Message表**：存储具体消息内容
- **Feedback表**：存储用户反馈

## 🔧 技术实现

### 后端API
- `/api/auth/register` - 用户注册
- `/api/auth/[...nextauth]` - 认证处理
- `/api/chat` - 聊天接口（自动保存消息）
- `/api/conversations` - 会话管理
- `/api/conversations/[id]/messages` - 消息查询

### 前端功能
- 自动检测用户登录状态
- 实时显示对话历史
- 支持会话切换和删除
- 消息实时保存和同步

## 📊 数据保存流程

1. **用户注册/登录**
   ```
   用户填写信息 → 密码加密 → 保存到User表 → 创建会话
   ```

2. **发送消息**
   ```
   用户输入 → 检查会话ID → 调用AI API → 保存用户消息 → 保存AI回复
   ```

3. **数据查询**
   ```
   前端请求 → 验证用户身份 → 查询用户会话 → 返回消息列表
   ```

## 🧪 测试验证

系统已通过完整测试：

### 测试项目
- ✅ 用户注册和登录
- ✅ 会话创建和管理
- ✅ 消息保存和检索
- ✅ 数据关联和完整性
- ✅ API兼容性
- ✅ 数据库操作

### 测试结果
```
📈 系统统计:
- 用户注册: ✅ 正常
- 会话创建: ✅ 正常  
- 消息保存: ✅ 正常
- 数据查询: ✅ 正常
- 关系维护: ✅ 正常
```

## 🚀 部署说明

### 环境变量
```bash
# DeepSeek API
DEEPSEEK_API_KEY=your-api-key
DEEPSEEK_MODEL=deepseek-chat

# 数据库
POSTGRES_PRISMA_URL=your-postgres-url
DATABASE_URL=your-postgres-url

# 认证
NEXTAUTH_URL=https://your-domain.com
NEXTAUTH_SECRET=your-secret-key
```

### 部署步骤
1. 设置环境变量
2. 运行数据库迁移：`npx prisma db push`
3. 构建应用：`npm run build`
4. 部署到生产环境

## 📝 使用说明

### 用户操作
1. **注册账户**：访问 `/register` 页面
2. **登录系统**：访问 `/login` 页面
3. **开始对话**：登录后即可开始聊天
4. **查看历史**：左侧边栏显示所有对话
5. **切换对话**：点击左侧对话列表

### 开发者操作
1. **查看数据**：使用 Prisma Studio 或数据库客户端
2. **调试日志**：查看控制台输出的详细日志
3. **API测试**：使用提供的测试脚本

## 🔍 故障排除

### 常见问题
1. **消息未保存**：检查用户是否已登录
2. **会话丢失**：检查数据库连接
3. **API错误**：检查DeepSeek API密钥和余额

### 调试方法
1. 查看浏览器控制台日志
2. 检查服务器日志
3. 运行测试脚本验证功能

## 📞 技术支持

如有问题，请检查：
1. 数据库连接是否正常
2. 环境变量是否正确设置
3. API密钥是否有效
4. 用户是否已正确登录

---

**注意**：当前DeepSeek API密钥显示余额不足，需要充值后才能正常使用AI功能，但数据保存功能已完全正常。
